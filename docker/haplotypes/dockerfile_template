FROM quay.io/singlecellpipelinetest/miniconda3:4.8.2

ADD . /app
RUN conda install --file /app/requirements.yml

RUN rm -rf /opt/conda/lib/python2.7/site-packages/remixt* && apt-get update && apt install libc-dev libz-dev build-essential -y && rm -rf /var/lib/apt/lists/* && conda install -c bioconda cython

RUN pip install git+https://github.com/shahcompbio/pypeliner.git@v0.6.0
RUN pip install git+https://github.com/shahcompbio/single_cell_pipeline.git@{git_commit}

RUN pip install git+https://github.com/amcpherson/remixt.git@v0.5.13
RUN mkdir -p /root/.config/matplotlib && echo "backend : Agg" > /root/.config/matplotlib/matplotlibrc
RUN pip install azure-batch azure-common azure-core azure-storage-blob azure-identity
